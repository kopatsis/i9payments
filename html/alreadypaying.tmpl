<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cancel Membership</title>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.2.3"></script>
  </head>
  <body>
    <p>Email: {{.Email}}</p>
    {{ if .External }}
    <p>Your payment is managed externally through {{.External}}.</p>
    {{ else }}
    <p>
      Your payment is managed by a card with the brand {{.Brand}} and last four
      digits of {{.Four}}.
    </p>
    {{ end }}

    <div x-data="cancelHandler()" x-init="init()">
      <form id="cancel-form" @submit.prevent="handleSubmit">
        <input type="hidden" name="user" value="{{.UserID}}" />
        <button type="submit">Manage Membership</button>
      </form>
      <div x-show="errorMessage" x-text="errorMessage" style="color: red"></div>
    </div>

    <script>
      function cancelHandler() {
        return {
          email: "{{.Email}}",
          userId: "{{.UserID}}",
          external: "{{.External}}",
          cardBrand: "{{.Brand}}",
          lastFour: "{{.Four}}",
          errorMessage: "",

          async handleSubmit() {
            this.errorMessage = "";
            const form = document.getElementById("cancel-form");
            const formData = new FormData(form);

            const response = await fetch("/cancel_membership", {
              method: "POST",
              body: formData,
            });

            if (response.ok) {
              window.location.href = "/";
            } else {
              const result = await response.json();
              this.errorMessage =
                "Failed to cancel membership: " +
                (result.message || response.statusText);
            }
          },
        };
      }

      document.addEventListener("alpine:init", () => {
        Alpine.data("cancelHandler", cancelHandler);
      });
    </script>

    <div
      id="user-data"
      data-email="{{.Email}}"
      data-id="{{.UserID}}"
      data-customer="{{.Customer}}"
      data-subscription="{{.Subscription}}"
      style="display: none"
    ></div>
  </body>
</html>
